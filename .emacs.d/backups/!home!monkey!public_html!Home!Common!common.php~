<?php
/*
 * date:2011-01-16
 * author:Monkey
 * Copyright (c) 2012 http://www.itlodge.net All rights reserved.
 *
 */

/*获得访问量*/
function get_access()
{
	$ip = get_client_ip();
	$access = M("Access");

	$date = mktime(0,0,0,date("m"),date("d"),date("Y"));
	$list = $access->where("id != 1")->select();
	if(!empty($list)){
		foreach($list as $arr){
			if($date > strtotime($arr["time"])){
				$id = $arr["id"];
				$access->where("id=$id")->delete();
			}
		}
	}
	$var = $access->where("ip='$ip'")->getField("times");
	if($var == NULL){
		$data["ip"] = $ip;
		$access->add($data);
		$access->where("id=1")->setInc("times");
	}
	
	$ac["today"] = $access->count() - 1;
	$ac["total"] = $access->where("id=1")->getField("times");
	return $ac;
}


/**
 * 截取HTML,并自动补全闭合
 * @param $html
 * @param $length
 * @param $end
 */
function subHtml($html,$length) 
{
	 $result = '';
	 $tagStack = array();
	 $len = 0;
	
	 $contents = preg_split("~(<[^>]+?>)~si",$html, -1,PREG_SPLIT_NO_EMPTY| PREG_SPLIT_DELIM_CAPTURE);
	 foreach($contents as $tag)
	 {
		 if (trim($tag)=="")
		 	continue;
		 if(preg_match("~<([a-z0-9]+)[^/>]*?/>~si",$tag)){
		 	$result .= $tag;
		 }else if(preg_match("~</([a-z0-9]+)[^/>]*?>~si",$tag,$match)){
		 	if($tagStack[count($tagStack)-1] == $match[1]){
				 array_pop($tagStack);
				 $result .= $tag;
		 	}
		 }else if(preg_match("~<([a-z0-9]+)[^/>]*?>~si",$tag,$match)){
			 array_push($tagStack,$match[1]);
			 $result .= $tag;
		 }else if(preg_match("~<!--.*?-->~si",$tag)){
			 $result .= $tag;
		 }else{
			 if($len + mstrlen($tag) < $length){
				 $result .= $tag;
				 $len += mstrlen($tag);
			 }else {
				 $str = msubstr($tag,0,$length-$len+1);
				 $result .= $str;
			 	 break;
			 }
	 	}
	 }
	 while(!empty($tagStack)){
		 $result .= '</'.array_pop($tagStack).'>';
	 }
	 return $result;
}

/**
 * 截取中文字符串
 * @param $string 字符串
 * @param $start 起始位
 * @param $length 长度
 * @param $charset&nbsp; 编码
 * @param $dot 附加字串
 */
function it_msubstr($string, $start, $length,$dot='',$charset = 'UTF-8') 
{
	 $string = str_replace(array('&amp;', '&quot;', '&lt;', '&gt;','&nbsp;'), 
	 	array('&', '"', '<', '>',' '), $string);
	 if(strlen($string) <= $length) {
	 	return $string;
	 }
	
	 if(strtolower($charset) == 'utf-8') {
	 	$n = $tn = $noc = 0;
		 while($n < strlen($string)) {
			 $t = ord($string[$n]);
			 if($t == 9 || $t == 10 || (32 <= $t && $t <= 126)) {
			 	$tn = 1; $n++;
			 } else if(194 <= $t && $t <= 223) {
			 	$tn = 2; $n += 2;
			 } else if(224 <= $t && $t <= 239) {
			 	$tn = 3; $n += 3;
			 } else if(240 <= $t && $t <= 247) {
			 	$tn = 4; $n += 4;
			 } elseif(248 <= $t && $t <= 251) {
				 $tn = 5; $n += 5;
			 } elseif($t == 252 || $t == 253) {
			 	$tn = 6; $n += 6;
			 } else {
			 	$n++;
		 	 }
			 $noc++;
			 if($noc >= $length) {
			 	break;
			 }
		}
	    if($noc > $length) {
		    $n -= $tn;
	    }
	 	$strcut = substr($string, 0, $n);
	 } else {
		 for($i = 0; $i < $length; $i++) {
		 	$strcut .= ord($string[$i]) > 127 ? $string[$i].$string[++$i] : $string[$i];
		 }
	 }
	
	 return $strcut.$dot;
}

/**
 * 取得字符串的长度，包括中英文。
 */
function mstrlen($str,$charset = 'UTF-8')
{
	 if (function_exists('mb_substr')) {
	 	$length=mb_strlen($str,$charset);
	 } elseif (function_exists('iconv_substr')) {
	 	$length=iconv_strlen($str,$charset);
	 } else {
		 preg_match_all("/[\x01-\x7f]|[\xc2-\xdf][\x80-\xbf]|\xe0[\xa0-\xbf][\x80-\xbf]|[\xe1-\xef][\x80-\xbf][\x80-\xbf]|\xf0[\x90-\xbf][\x80-\xbf][\x80-\xbf]|[\xf1-\xf7][\x80-\xbf][\x80-\xbf][\x80-\xbf]/", 
		 	$text, $ar);
		 $length=count($ar[0]);
	 }
	 return $length;
}

function SpHtml2Text($str)
{
	$str = preg_replace("/<sty(.*)\\/style>|<scr(.*)\\/script>|<!--(.*)-->/isU","",$str);
	$alltext = "";
	$start = 1;
	for($i=0;$i<strlen($str);$i++)
	{
		if($start==0 && $str[$i]==">")
		{
			$start = 1;
		}
		else if($start==1)
		{
			if($str[$i]=="<")
			{
				$start = 0;
				$alltext .= " ";
			}
			else if(ord($str[$i])>31)
			{
				$alltext .= $str[$i];
			}
		}
	}
	$alltext = str_replace("　"," ",$alltext);
	$alltext = preg_replace("/&([^;&]*)(;|&)/","",$alltext);
	$alltext = preg_replace("/[ ]+/s"," ",$alltext);
	return $alltext;
}

function Html2Text($str,$r=0)
{
        if($r==0)
        {
            return SpHtml2Text($str);
        }
        else
        {
            $str = SpHtml2Text(stripslashes($str));
            return addslashes($str);
        }
}

function show_ad($aList,$name)
{
	for($i = 0; $i < count($aList);$i++){
		if($aList[$i]['apname'] == $name){
			echo $aList[$i]['acode'];
			break;
		}
	}
}

function show_qrcode($chl,$widhtHeight ='150',$EC_level='L',$margin='0')
{
	$chl = urlencode($chl);
	echo '<img src="http://chart.apis.google.com/chart?chs='.$widhtHeight.'x'.$widhtHeight.
		'&cht=qr&chld='.$EC_level.'|'.$margin.'&chl='.$chl.'" alt="QR code" widhtHeight="'.
		$widhtHeight.'" widhtHeight="'.$widhtHeight.'"/>';
}

?>
